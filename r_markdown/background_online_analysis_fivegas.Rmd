---
title: "background analysis template"
author: "Nicholas Good"
date: "12/15/2016"
output: html_document
---

# Setup

1. Create working directory
2. Download lastest .Rda files folder from server (r_files) and place in working directory
3. Create RStudio project in working directory

# Libraries

The dataset has been optimized to work with `tidyverse`. It is strongly recommended you use `tidyverse` packages for data manipulation and plotting.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
```

# Source files

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_functions.R")
```

# Load data

* First we'll load the sample info data.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/samples.Rda")

```

* Next we'll load the sample times file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/test_times.Rda")
```

* Next we'll load the pollutant data we're interested in. In this case we're going to look at the CO (five gas) data:

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/fivegas_merged.Rda")

  pol_data <- fivegas_merged
```

# Extract data

* 10 minutes before and after each test

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}  
  times_pre <- dplyr::filter(test_times, var == "ignite") %>%
               tidyr::spread(var, value) %>%
               dplyr::select(-date) %>%
               dplyr::rename(end = ignite) %>%
               dplyr::mutate(start = end - 10*60)

  times_post <- dplyr::filter(test_times, var == "end") %>%
                tidyr::spread(var, value) %>%
                dplyr::select(-date) %>%
                dplyr::rename(start = end) %>%
                dplyr::mutate(end = start + 10*60)

  times_sample <- dplyr::filter(test_times,
                                var == "start_1" | var == "shutdown") %>%
                  tidyr::spread(var, value) %>%
                  dplyr::select(-date) %>%
                  dplyr::rename(start = start_1, end = shutdown)
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_pre <- filter_times(times_pre, pol_data)
  df_pre <- dplyr::mutate(df_pre, type = "pre")
  
  df_post <- filter_times(times_post, pol_data)
  df_post <- dplyr::mutate(df_post, type = "post")
  
  df_sample <- filter_times(times_sample, pol_data)
  df_sample <- dplyr::mutate(df_sample, type = "sample")
  
  df <- rbind(df_pre, df_post, df_sample)
```

## Analyze

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  out <- dplyr::group_by(df, id, type, pol) %>%
         dplyr::summarise(mean = mean(val)) %>%
         dplyr::ungroup()
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 12, fig.height=8}
  ggplot(out, aes(id, mean, colour = type)) +
  geom_point() +
  facet_wrap(~ pol, scales = "free") +
  ggtitle("FiveGas") +
  theme_minimal()
```